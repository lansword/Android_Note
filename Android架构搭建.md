 [æœ¬æ–‡è½¬è½½è‡ªè¿™é‡Œ]([huannan/XArch: ğŸ”¥ğŸ”¥ğŸ”¥Androidæ¶æ„æœ€ä½³å®è·µ - æ‰‹æŠŠæ‰‹å¸¦ä½ æ­å»ºä¸€ä¸ªä¼˜ç§€çš„Androidé¡¹ç›®æ¶æ„ (github.com)](https://github.com/huannan/XArch))

[![å°é¢](https://camo.githubusercontent.com/ffc1192c400521b5dd184584bc4cb43613592ca2bc14f677570619062cdd7cd1/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d356231356135306434626439623035342e6a7065673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/ffc1192c400521b5dd184584bc4cb43613592ca2bc14f677570619062cdd7cd1/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d356231356135306434626439623035342e6a7065673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

### ç›®å½•

- [å‰è¨€](https://github.com/huannan/XArch#å‰è¨€)
- [æ¶æ„æ€»ä½“ä»‹ç»](https://github.com/huannan/XArch#æ¶æ„æ€»ä½“ä»‹ç»)
- [Gradleé…ç½®ç»Ÿä¸€ç®¡ç†](https://github.com/huannan/XArch#gradleé…ç½®ç»Ÿä¸€ç®¡ç†)
- [åŸºç±»å°è£…](https://github.com/huannan/XArch#åŸºç±»å°è£…)
- [è§†å›¾ç»‘å®š](https://github.com/huannan/XArch#è§†å›¾ç»‘å®š)
- [åº•éƒ¨å¯¼èˆªæ çš„å®ç°](https://github.com/huannan/XArch#åº•éƒ¨å¯¼èˆªæ çš„å®ç°)
- [äº‹ä»¶æ€»çº¿æ¡†æ¶å°è£…](https://github.com/huannan/XArch#äº‹ä»¶æ€»çº¿æ¡†æ¶å°è£…)
- [åˆ—è¡¨æ¶æ„å°è£…](https://github.com/huannan/XArch#åˆ—è¡¨æ¶æ„å°è£…)
- [ç½‘ç»œæ¶æ„æ­å»º](https://github.com/huannan/XArch#ç½‘ç»œæ¶æ„æ­å»º)
- [æŒä¹…åŒ–](https://github.com/huannan/XArch#æŒä¹…åŒ–)
- [æœŸæœ›å’Œæ€»ç»“](https://github.com/huannan/XArch#æœŸæœ›å’Œæ€»ç»“)

### å‰è¨€

æœ€è¿‘å…¬å¸å‡†å¤‡ä¸Šçº¿æ–°é¡¹ç›®ï¼Œç”±ç¬”è€…æ¥è´Ÿè´£æ­å»ºé¡¹ç›®æ¶æ„ï¼Œæ­£å¥½ä¹ŸæŠŠä¹‹å‰å­¦çš„Kotlinç­‰ç›¸å…³çŸ¥è¯†å·©å›ºä¸€ä¸‹ï¼Œäºæ˜¯æŠŠæ­å»ºçš„æˆæœæŠ½å–å‡ºæ¥ä½œä¸ºå¼€æºé¡¹ç›®åˆ†äº«ç»™å¤§å®¶ã€‚å¦å¤–ï¼Œè¯¥é¡¹ç›®ä¹Ÿæ˜¯å¤§å®¶å­¦ä¹ Kotlinä¸€ä¸ªå¾ˆå¥½çš„ç¤ºä¾‹ï¼Œå¦å¤–è¯¥é¡¹ç›®ç¨ä½œä¿®æ”¹å®Œå…¨å¯ä»¥ä½œä¸ºä¸€ä¸ªæ–°é¡¹ç›®çš„è“æœ¬ã€‚

ä¸‹é¢æ”¾ä¸Šå‡ å¼ é¡¹ç›®æ•ˆæœå›¾ï¼š

[![é¦–é¡µ](https://camo.githubusercontent.com/f5b3a46c44d5fc84192201d32c72efa6c52586f84fd13797d44ff832535a28e3/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d653138636234616335303562366132362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/f5b3a46c44d5fc84192201d32c72efa6c52586f84fd13797d44ff832535a28e3/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d653138636234616335303562366132362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

[![äºŒæ¬¡å…ƒ](https://camo.githubusercontent.com/96c3bd47fb67a02b1bdd0996fe2c5c450d92425c8bd07afb0b41455dc54cd2eb/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d643833343561396138303430663733632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/96c3bd47fb67a02b1bdd0996fe2c5c450d92425c8bd07afb0b41455dc54cd2eb/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d643833343561396138303430663733632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

[![å‘ç°](https://camo.githubusercontent.com/7a9685b8d430abc4bdb9296e5f1d862900549e4530d646dc6ff3c0f4599aabc1/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d616261366337373730623163323732632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/7a9685b8d430abc4bdb9296e5f1d862900549e4530d646dc6ff3c0f4599aabc1/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d616261366337373730623163323732632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

[![æˆ‘çš„](https://camo.githubusercontent.com/c7db24b7560dcf4d60c0084355782f0e518d8e06766388144259dff0e5efa625/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d653135363232653134366561656635352e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/c7db24b7560dcf4d60c0084355782f0e518d8e06766388144259dff0e5efa625/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d653135363232653134366561656635352e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

### æ¶æ„æ€»ä½“ä»‹ç»

ä¸€ä¸ªè‰¯å¥½çš„æ¶æ„éœ€è¦ä»€ä¹ˆï¼Œæ ¹æ®è®¾è®¡åŸåˆ™ï¼Œæœ‰ä»¥ä¸‹ï¼š

- å®ç°é¡¹ç›®æ‰€éœ€è¦çš„åŠŸèƒ½ï¼Œä¸ºä¸šåŠ¡éœ€æ±‚æ‰“ä¸‹åŸºç¡€
- å¯æ‰©å±•æ€§ã€å¯é…ç½®æ€§è¶³å¤Ÿå¼ºå¤§
- æ˜“ç”¨æ€§ï¼Œæ–¹ä¾¿æ–°æˆå‘˜å­¦ä¹ å’Œä¸Šæ‰‹
- ä»£ç é«˜å¯å¤ç”¨æ€§ï¼Œæ·»åŠ æ–°åŠŸèƒ½çš„æ—¶å€™å¯ä»¥é‡ç”¨å¤§éƒ¨åˆ†å·²æœ‰ä»£ç 

åœ¨å¼€å§‹ä¹‹å‰ï¼Œçœ‹äº†å…¬å¸å†…éƒ¨å¾ˆå¤šé¡¹ç›®çš„æ¶æ„ï¼Œå¤§éƒ¨åˆ†éƒ½ä¸å¦‚äººæ„ï¼Œè¯¸å¦‚ä»¥ä¸‹çš„é—®é¢˜æ»¡å¤©é£ï¼š

- åŸæœ‰APIååˆ†éš¾ç”¨ï¼Œæ¯”å¦‚è¯´æ·»åŠ ä¸€ä¸ªç®€å•çš„åŸ‹ç‚¹ï¼Œå¤§éƒ¨åˆ†æƒ…å†µéœ€è¦å»ç¿»çœ‹å’Œæ‹·è´å·²æœ‰çš„ä»£ç æ‰èƒ½ä½¿ç”¨
- Adapterå¾ˆå¤šå¾ˆä¹±ï¼Œæ¯ä¸€ä¸ªå®ç°éƒ½å‚å·®ä¸é½ï¼Œåˆ—è¡¨Itemæ²¡æœ‰å¤ç”¨ï¼Œæœ¬æ¥åº”è¯¥å¤ç”¨çš„Itemå†™äº†å¤šæ¬¡ï¼ŒAdapterä¹Ÿæ˜¯ä¸€ä¸ªé¡µé¢å†™ä¸€ä¸ªï¼Œéå¸¸éš¾ä»¥ç»Ÿä¸€ç®¡ç†
- ç½‘ç»œæ¶æ„ååˆ†ä¹±ï¼ŒåŒä¸€ä¸ªé¡¹ç›®ç”±äºå†å²åŸå› ä¼šæœ‰å¤šä¸ªç½‘ç»œæ¶æ„ï¼›å¹¶ä¸”APIååˆ†éš¾ä»¥ä½¿ç”¨ï¼Œæ¯æ¬¡ä½¿ç”¨è¿˜è¦æ‰‹åŠ¨å»åˆ›å»ºä¸€æ¬¡Retrofitçš„Serviceæ‰èƒ½è°ƒç”¨API
- å¤§é‡çš„findViewByIdï¼Œæƒ³è¦ä¿®æ”¹æˆ–è€…é‡æ„ä»£ç çš„æ—¶å€™éœ€è¦ä¿®æ”¹å¤§é‡å†…å®¹
- åŒ…ç®¡ç†åˆ’åˆ†æ··ä¹±ç­‰ç­‰

ä¸‹é¢æ˜¯å­¦ä¹ è¯¥æ¶æ„å¯ä»¥å­¦ä¹ ã€å·©å›ºçš„çŸ¥è¯†ï¼š

- Kotlinå„ç§è¯­æ³•ç­‰
- Jetpackï¼šä¸»è¦æ˜¯ViewModelã€LifeCycleã€LiveDataã€Roomã€ViewBinding
- Kotlinåç¨‹
- æ€è€ƒå“ªäº›åœ°æ–¹å¯èƒ½ä¼šå­˜åœ¨å¤šçº¿ç¨‹å¸¦æ¥çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ä»¥åŠå¤„ç†æ–¹æ¡ˆ
- Retrofit+OkHttp
- MultiType
- MMKV
- ç­‰ç­‰

ä¸‹é¢å…ˆæ¥çœ‹ä¸€ä¸‹é¡¹ç›®æ€»ä½“çš„åŒ…åˆ’åˆ†ï¼š

[![é¡¹ç›®æ€»ä½“æ¶æ„](https://camo.githubusercontent.com/3689937eac63146d886b97e35e7384503e7f1ebc49e4c2c8fc4a696706e3b22c/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d383832386165363431336163633861352e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/3689937eac63146d886b97e35e7384503e7f1ebc49e4c2c8fc4a696706e3b22c/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d383832386165363431336163633861352e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

baseï¼šå­˜æ”¾æ‰€æœ‰ä¸šåŠ¡çš„åŸºç¡€ç±»ï¼ŒåŒ…æ‹¬BaseActivityã€BaseFragmentã€BaseViewModelã€åˆ—è¡¨ç­‰åŠŸèƒ½çš„å°è£… beanï¼šå­˜æ”¾æ‰€æœ‰Beanç±»ï¼Œä¸€èˆ¬å¤šä¸ºKotlinçš„data class constantï¼šå­˜æ”¾æ‰€æœ‰å¸¸é‡ eventbusï¼šé¡¹ç›®å°è£…XEventBusï¼ŒåŸºäºLiveData itemï¼šå­˜æ”¾æ‰€æœ‰å¯é‡ç”¨çš„åˆ—è¡¨Item moduleï¼šå­˜æ”¾ä»¥ä¸šåŠ¡åŠŸèƒ½åˆ’åˆ†ï¼ˆä¸€èˆ¬æ˜¯ä»¥é¡µé¢ä¸ºåˆ’åˆ†ç•Œé™ï¼‰çš„æ‰€æœ‰æ¨¡å—ï¼Œæ¯ä¸€ä¸ªæ¨¡å—çš„packageåŒ…å«æ¨¡å—æ‰€éœ€è¦çš„ç±»ï¼Œä¸€èˆ¬ä¸ºActivity/Fragmentä»¥åŠä¸ä¹‹å¯¹åº”çš„ViewModel networkï¼šåŸºäºRetrofit+OkHttp+åç¨‹çš„ç½‘ç»œæ¶æ„å°è£… persistenceï¼šå­˜æ”¾æ•°æ®åº“ä»¥åŠé”®å€¼å¯¹ç­‰æŒä¹…åŒ–ç›¸å…³çš„ç±» utilï¼šå·¥å…·ç±»ï¼ŒåŒ…å«Kotlinæ‰©å±•å±æ€§ã€æ‰©å±•å‡½æ•° widgetï¼šå­˜æ”¾æ‰€æœ‰è‡ªå®šä¹‰æ§ä»¶ XArchApplicationï¼šé¡¹ç›®çš„Application

ç”±äºæ˜¯ä½œä¸ºç¤ºä¾‹é¡¹ç›®ï¼Œå°±æš‚ä¸è€ƒè™‘å¤šmoduleåˆ’åˆ†ä¹‹ç±»çš„é—®é¢˜äº†ã€‚

### Gradleé…ç½®ç»Ÿä¸€ç®¡ç†

æ­å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå…ˆä»Gradleå…¥æ‰‹ï¼ŒæŠŠæ‰€æœ‰éœ€è¦çš„ä¾èµ–éƒ½ä¾èµ–è¿›æ¥ï¼Œä¸ºåé¢çš„å·¥ä½œæ‰“ä¸‹åŸºç¡€ã€‚

å¯¹äºGradleé…ç½®ç»Ÿä¸€ç®¡ç†è¿™ä¸€å—ï¼Œç¬”è€…å†™äº†ä¸€ä¸ªconfig.gradleè„šæœ¬ï¼š

```
/**
 * ä¾èµ–åº“ç‰ˆæœ¬ç®¡ç†
 */
def versions = [:]
versions.androidx_appcompat = "1.3.1"
...
ext.versions = versions

/**
 * APPç‰ˆæœ¬å·ã€æ’ä»¶ç‰ˆæœ¬ã€ç¼–è¯‘ç›¸å…³ç‰ˆæœ¬ç®¡ç†
 */
def build_versions = [:]
build_versions.min_sdk = 21
build_versions.app_version_name = "1.0.0"
...
ext.build_versions = build_versions

/**
 * è·¯å¾„å¸¸é‡
 */
def paths = [:]
paths.room_schema = "$projectDir/schemas"
ext.paths = paths

/**
 * ä»“åº“åœ°å€ç®¡ç†
 */
def addRepos(RepositoryHandler handler) {
    handler.maven {
        allowInsecureProtocol true
        url 'http://maven.aliyun.com/nexus/content/groups/public/'
    }
    ...
}

ext.addRepos = this.&addRepos

/**
 * è¯»å–æœ¬æœºé…ç½®ï¼Œä¸»è¦ç”¨äºæœ¬åœ°å·®å¼‚åŒ–æ„å»º(local.propertiesä¸ä¼šæäº¤åˆ°ä»“åº“)
 */
def readLocalProperty(String key) {
    boolean value = false
    def file = rootProject.file('local.properties')
    if (file.exists() && file.isFile()) {
        Properties properties = new Properties()
        properties.load(file.newDataInputStream())
        value = Boolean.parseBoolean(properties.getProperty(key, 'false'))
    }
    println(String.format("property key=%s value=%S", key, value))
    return value
}

ext.readLocalProperty = this.&readLocalProperty
```

å…¶ä¸­ï¼Œ

- versionsæ˜¯æ‰€æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–åº“çš„ç‰ˆæœ¬
- build_versionsæ˜¯æ‰€æœ‰æ„å»ºç›¸å…³çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚æœ€å°SDKã€APPç‰ˆæœ¬å·ç­‰
- pathsæ˜¯æ‰€æœ‰è·¯å¾„å¸¸é‡
- addReposæ˜¯æ‰€æœ‰ä»“åº“åœ°å€
- readLocalPropertyæ˜¯è¯»å–æœ¬æœºçš„é…ç½®ï¼Œä»è€Œåšä¸€äº›å·®å¼‚åŒ–é…ç½®ã€‚

è¿™é‡Œå†è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯æœ¬æœºé…ç½®ï¼Œæœ¬æœºçš„é…ç½®åœ¨local.propertiesï¼Œè€Œè¯¥æ–‡ä»¶ä¸ä¼šæäº¤åˆ°Gitï¼Œæ‰€ä»¥åœ¨local.propertiesé…ç½®çš„å±æ€§ï¼Œåªç”¨äºæ”¹å˜ä½ æœ¬åœ°çš„æ„å»ºã€‚æ¯”å¦‚æˆ‘è¦åœ¨æœ¬åœ°è°ƒè¯•çš„æ—¶å€™ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ’æŸ¥çš„å·¥å…·ï¼Œä½†æ˜¯åˆä¸æƒ³å½±å“æŒç»­é›†æˆç¼–è¯‘å‡ºæ¥çš„APKåŒ…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨local.propertiesé‡Œé¢å¢åŠ ä»¥ä¸‹ä¸€è¡Œï¼š

```
THREAD_POOL_SHRINK=false
```

ç„¶åä½ å¯ä»¥åœ¨build.gradleé‡Œé¢å¢åŠ ä»¥ä¸‹é…ç½®ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°åªæœ‰ä½ è‡ªå·±æœ¬æœºæ‰èƒ½å¼€å¯è¿™ä¸ªæ’ä»¶ï¼Œè€Œä¸ä¼šå½±å“æŒç»­é›†æˆç¼–è¯‘å‡ºæ¥çš„APKåŒ…ã€‚è¿™ä¸ªæ˜¯ç¬”è€…æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªå°æŠ€å·§ã€‚

```
// çº¿ç¨‹æ± ä¼˜åŒ–Gradleæ’ä»¶ï¼Œæµ‹è¯•ç¨³å®šåå†ä¸Šçº¿ï¼Œç›®å‰ä»…ç”¨äºçº¿ç¨‹æ± æ’æŸ¥
if (readLocalProperty("THREAD_POOL_SHRINK")) {
    apply from: "thread.gradle"
}
```

ä»‹ç»å®Œå…¨å±€é…ç½®è„šæœ¬config.gradleï¼Œæ¥ä¸‹æ¥åœ¨é¡¹ç›®çš„æ ¹é¡¹ç›®é‡Œé¢applyä¸€ä¸‹ï¼Œå°±å¯ä»¥å…¨å±€ä½¿ç”¨config.gradleæ‰€å®šä¹‰çš„ä¿¡æ¯äº†ï¼š

```
buildscript {
    apply from: 'config.gradle'
    addRepos(repositories)
    dependencies {
        classpath "com.android.tools.build:gradle:$build_versions.android_gradle_plugin"
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:${build_versions.kotlin}"
    }
}

allprojects {
    addRepos(repositories)
}
...
```

è‡³æ­¤ï¼ŒGradleé…ç½®ç»Ÿä¸€ç®¡ç†è¿™ä¸€å—å°±å®ç°å¥½äº†ï¼Œä¸ºåé¢å¤šmoduleæ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚

å½“ç„¶ï¼Œå…³äºGradleé…ç½®ç»Ÿä¸€ç®¡ç†è¿™ä¸€å—å¯ä»¥å±•å¼€çš„å†…å®¹å®åœ¨å¤ªå¤šäº†ï¼Œé’ˆå¯¹å¤šmoduleç”šè‡³å¤šé¡¹ç›®ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œè¿™é‡Œé’ˆå¯¹ç›®å‰çš„é¡¹ç›®éœ€æ±‚ï¼Œé‡‡ç”¨æœ€ç®€å•çš„æ–¹å¼å°±å¥½äº†ï¼Œæ­¤æ–¹æ³•é€‚åˆå¤§éƒ¨åˆ†ä¸­å°å‹é¡¹ç›®çš„éœ€è¦ã€‚

### åŸºç±»å°è£…

ä¸‹é¢æ­£å¼å¼€å§‹å†™ä»£ç ï¼Œå…ˆä»æœ€ç®€å•çš„åŸºç±»çš„å°è£…å…¥æ‰‹ï¼Œç›´æ¥ä¸Šä»£ç ï¼š

```
abstract class BaseActivity : SwipeBackActivity(), IGetPageName {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setSwipeBackEnable(swipeBackEnable())
    }

    override fun onStart() {
        super.onStart()
        // è¿™é‡Œå¯ä»¥æ·»åŠ é¡µé¢æ‰“ç‚¹
    }

    override fun onStop() {
        super.onStop()
        // è¿™é‡Œå¯ä»¥æ·»åŠ é¡µé¢æ‰“ç‚¹
    }

    /**
     * é»˜è®¤å¼€å¯å·¦æ»‘è¿”å›,å¦‚æœéœ€è¦ç¦ç”¨,è¯·é‡å†™æ­¤æ–¹æ³•
     */
    protected open fun swipeBackEnable() = true

    ...
}
```

1. ä»æ•´ä½“æ¥çœ‹ï¼ŒåŸºç±»çš„è®¾è®¡å¿…é¡»æ˜¯ä¸€ä¸ªabstract classï¼Œå¹¶ä¸”æä¾›å¿…è¦çš„é’©å­å‡½æ•°ç»™å­ç±»å®šåˆ¶ä»¥åŠæä¾›å…¬å…±çš„å¸¸ç”¨çš„å‡½æ•°
2. åœ¨åŸºç±»çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°é‡Œé¢å¯ä»¥åšä¸€äº›ç»Ÿä¸€çš„æ“ä½œï¼Œä¸€èˆ¬æ¥è¯´æ˜¯é¡µé¢çš„æ‰“ç‚¹ï¼Œå…¶ä¸­pageNameå¯ä»¥é€šè¿‡åŸºç¡€åŸºç±»å®ç°IGetPageNameæ¥æä¾›
3. å¯¹äºActivityè€Œè¨€ï¼Œæœ‰ä¸€äº›é¡µé¢å¯èƒ½éœ€è¦å³æ»‘è¿”å›åŠŸèƒ½ï¼Œæˆ‘ä»¬ç›´æ¥è®©BaseActivityç»§æ‰¿SwipeBackActivityå³å¯

å…¶ä»–çš„BaseFragmentã€BaseViewModeléƒ½æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚

ç‰¹åˆ«è¦è¯´æ˜ä¸€ç‚¹çš„æ˜¯ï¼Œç¬”è€…å€¾å‘äºä¸å¾€åŸºç±»æ·»åŠ ä¸€äº›é¢å¤–çš„æ–¹æ³•ï¼Œå°½é‡ä¿æŒä¸€ä¸ªç±»çš„çº¯ç²¹ã€‚å°±æ‹¿BaseActivityæ¥è¯´å§ï¼Œç¬”è€…ä¸ä¼šæ·»åŠ è¯¸å¦‚doCreateã€getContentViewä¹‹ç±»çš„å¥‡å¥‡æ€ªæ€ªçš„æ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·ä¼šç»™åˆæ¬¡ä½¿ç”¨çš„åŒäº‹å¸¦æ¥å›°æƒ‘ï¼Œè¿˜å¾—æ—¶ä¸æ—¶å»ç¿»çœ‹åŸºç±»çš„å®ç°ã€‚

åœ¨å…·ä½“ä½¿ç”¨æ–¹é¢ï¼Œç¬”è€…å»ºè®®æ˜¯å°†æ‰€æœ‰æ¨¡å—éƒ½åˆ’åˆ†ä¸€ä¸ªpackageï¼Œä¾‹å¦‚main packageé‡Œé¢ä¸€ä¸ªMainActivityå’ŒMainViewModelï¼š

[![åŒ…åˆ’åˆ†](https://camo.githubusercontent.com/d154aa32c5e6f13c1384d942f8b0719b26e69afca1810ffb2b7ad18c67f9a902/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d396533316338336663353239393264622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/d154aa32c5e6f13c1384d942f8b0719b26e69afca1810ffb2b7ad18c67f9a902/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d396533316338336663353239393264622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

å…·ä½“å¯ä»¥å‚è€ƒè°·æ­Œæä¾›çš„å®˜æ–¹æ¶æ„å›¾ï¼š

[![æ¨èæ¶æ„](https://camo.githubusercontent.com/fbdd1add2813bf3b02a2f4e41d81fb793e27c90eada7eb0834f42c4e74e164ea/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d353465643534303734373064346339312e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/fbdd1add2813bf3b02a2f4e41d81fb793e27c90eada7eb0834f42c4e74e164ea/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d353465643534303734373064346339312e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

æœ¬é¡¹ç›®çœç•¥äº†Repositoryå±‚ï¼Œè€ƒè™‘æ˜¯ä¸­å°å‹ç¤ºä¾‹é¡¹ç›®ä»¥åŠå¤§å®¶çš„å­¦ä¹ æˆæœ¬ï¼Œæš‚æ—¶æ²¡æœ‰åšä¸€å±‚ï¼Œæœ‰éœ€è¦çš„è¯å¤§å®¶å¯ä»¥è‡ªå·±å®ç°ã€‚

### è§†å›¾ç»‘å®š

æåˆ°è§†å›¾ç»‘å®šï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæƒ³åˆ°ä»¥ä¸‹å‡ ä¸ªç‚¹ï¼š

- findViewByIdï¼šé‡å¤ç¹çï¼Œæ— æ³•è§„é¿ç©ºæŒ‡é’ˆå’Œå¼ºè½¬æ—¶ç±»å‹é”™è¯¯é—®é¢˜(ç›®å‰é€šè¿‡æœ‰æ³›å‹å¯ä»¥è§„é¿)
- DataBindingï¼šè¿™ä¸ªæ˜¯å®ç°MVVMåŒå‘ç»‘å®šçš„å·¥å…·ï¼Œä¸¥æ ¼æ¥è¯´å®šä½ä¸Šä¸å±äºè§†å›¾ç»‘å®šå·¥å…·ï¼Œè§†å›¾ç»‘å®šåªæ˜¯DataBindingçš„éƒ¨åˆ†åŠŸèƒ½
- ButterKnife/Kotlin-Android-Extentionï¼šè§†å›¾ç»‘å®šå·¥å…·ï¼Œç›®å‰ç”±äºä»AGP-5.0ç‰ˆæœ¬å¼€å§‹ï¼ŒRç±»ç”Ÿæˆçš„å€¼ä¸å†æ˜¯å¸¸é‡ï¼Œè¿™ä¸¤ä¸ªå·¥å…·å·²åºŸå¼ƒï¼ˆå‚è€ƒï¼š https://blog.csdn.net/c10WTiybQ1Ye3/article/details/113695548ï¼‰
- ViewBindingï¼šè§†å›¾ç»‘å®šå·¥å…·ï¼Œä¸ç”¨æ‰‹å†™findViewByIdï¼Œè€Œä¸”é¿å…äº†findViewByIdå¯èƒ½ä¼šå¸¦æ¥çš„ç©ºæŒ‡é’ˆå’Œå¼ºè½¬æ—¶ç±»å‹é”™è¯¯é—®é¢˜(*)

åŸºäºä»¥ä¸Šè€ƒè™‘ï¼Œé¡¹ç›®å†³å®šé‡‡ç”¨ViewBindingã€‚

ä»¥ä¸‹æ˜¯åœ¨BaseActivityå’ŒBaseFragmentä¸­å¯¹ViewBindingçš„å°è£…ï¼š

```
/**
 * ActivityåŸºç±»
 */
abstract class BaseActivity<T : ViewBinding>(val inflater: (inflater: LayoutInflater) -> T) : SwipeBackActivity() {

    protected lateinit var viewBinding: T

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        viewBinding = inflater(layoutInflater)
        setContentView(viewBinding.root)
    }
}

/**
 * FragmentåŸºç±»
 */
abstract class BaseFragment<T : ViewBinding>(val inflater: (inflater: LayoutInflater, container: ViewGroup?, attachToRoot: Boolean) -> T) : Fragment() {

    protected lateinit var viewBinding: T

    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {
        viewBinding = this.inflater(inflater, container, false)
        return viewBinding.root
    }
}
```

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ³›å‹å‚æ•°ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªå­ç±»å¯ä»¥è®¿é—®çš„æˆå‘˜ï¼Œç„¶ååœ¨ä¸»æ„é€ å‡½æ•°é‡Œé¢æ·»åŠ äº†ViewBindingåˆå§‹åŒ–çš„é«˜é˜¶å‡½æ•°ï¼Œå¹¶ä¸”åœ¨å¯¹åº”çš„onCreate/onCreateViewé‡Œé¢è°ƒç”¨è¿™ä¸ªé«˜é˜¶å‡½æ•°åˆå§‹åŒ–ViewBindingï¼Œåœ¨ç»§æ‰¿Baseç±»çš„æ—¶å€™ï¼Œåªéœ€è¦ç®€å•ä¼ å…¥XXXViewBinding::inflateå³å¯ï¼Œä»¥MainActivityä¸ºä¾‹å­ï¼š

```
/**
 * é¦–é¡µ
 */
class MainActivity : BaseActivity<ActivityMainBinding>(ActivityMainBinding::inflate) {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // å¯ä»¥ç›´æ¥ä½¿ç”¨viewBindingäº†
        viewBinding.xxx
    }
}
```

### åº•éƒ¨å¯¼èˆªæ çš„å®ç°

åº•éƒ¨å¯¼èˆªæ åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªé¡¹ç›®çš„æ ‡é…äº†ï¼Œç›®å‰çš„å®ç°æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œç¬”è€…æŒ‘é€‰äº†æ¯”è¾ƒæˆç†Ÿæ–‡æ¡£ä¸”å¯æ‰©å±•æ€§å¼ºçš„æ”¹é€ FragmentTabHostæ–¹æ¡ˆã€‚

ç›¸å…³æ–‡ç« å¯ä»¥å‚è€ƒï¼š[Android åº•éƒ¨å¯¼èˆªæ (åº•éƒ¨Tab)æœ€ä½³å®è·µ](https://www.jianshu.com/p/0b9d5777abba)

åº•éƒ¨å¯¼èˆªæ çš„å®ç°ç¬”è€…é‡‡ç”¨FragmentTabHost+Fragmentæ¥å®ç°ï¼Œåªä¸è¿‡FragmentTabHostæ˜¯ç»è¿‡ç®€å•ä¿®æ”¹ï¼Œé˜²æ­¢Fragmentåœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­Fragmenté”€æ¯ã€‚

ç¤ºä¾‹ä»£ç å‚è€ƒMainActivity.ktï¼š

```
/**
 * åˆå§‹åŒ–åº•æ 
 */
private fun initTabs() {
    val tabs = listOf(
        Tab(TabId.HOME, getString(R.string.page_home), R.drawable.selector_btn_home, HomeFragment::class),
        Tab(TabId.SMALL_VIDEO, getString(R.string.page_small_video), R.drawable.selector_btn_small_video, SmallVideoFragment::class),
        Tab(TabId.ACGN, getString(R.string.page_acgn), R.drawable.selector_btn_acgn, AcgnFragment::class),
        Tab(TabId.GOLD, getString(R.string.page_gold), R.drawable.selector_btn_gold, GoldFragment::class),
        Tab(TabId.MINE, getString(R.string.page_mine), R.drawable.selector_btn_mine, MineFragment::class)
    )

    viewBinding.fragmentTabHost.run {
        // è°ƒç”¨setup()æ–¹æ³•ï¼Œè®¾ç½®FragmentManagerï¼Œä»¥åŠæŒ‡å®šç”¨äºè£…è½½Fragmentçš„å¸ƒå±€å®¹å™¨
        setup(this@MainActivity, supportFragmentManager, viewBinding.fragmentContainer.id)
        tabs.forEach {
            // è¿™é‡Œæ˜¯è§£æ„çš„è¯­æ³•
            val (id, title, icon, fragmentClz) = it
            val tabSpec = newTabSpec(id).apply {
                setIndicator(TabIndicatorView(this@MainActivity).apply {
                    viewBinding.tabIcon.setImageResource(icon)
                    viewBinding.tabTitle.text = title
                })
            }
            addTab(tabSpec, fragmentClz.java, null)
        }

        setOnTabChangedListener { tabId ->
            currentTabId = tabId
            updateTitle()
        }
    }
}

/**
 * è®¾ç½®å½“å‰é€‰ä¸­çš„TAB
 */
private fun setCurrentTab(@TabId tabID: String) {
    viewBinding.fragmentTabHost.setCurrentTabByTag(tabID)
}
```

åœ¨initTabså‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨FragmentTabHostçš„setupæ–¹æ³•è®¾ç½®FragmentManagerï¼Œä»¥åŠæŒ‡å®šç”¨äºè£…è½½Fragmentçš„å¸ƒå±€å®¹å™¨ã€‚ç„¶åé€šè¿‡addTabæ–¹æ³•æŠŠåˆ›å»ºå¥½çš„TabSpecä¼ è¿›å»å³å¯ã€‚å…¶ä¸­TabIndicatorViewæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ¯ä¸€ä¸ªåº•éƒ¨å¯¼èˆªæ æ˜¾ç¤ºçš„æ§ä»¶ã€‚

### äº‹ä»¶æ€»çº¿æ¡†æ¶å°è£…

æåˆ°äº‹ä»¶æ€»çº¿ï¼Œæˆ‘ä»¬ä¸å¤–ä¹ä¼šæƒ³åˆ°ï¼š

- EventBusåº“
- RXJava
- LiveData

æ—¢ç„¶ä¸Šäº†Jetpackè¿™æ¡è´¼èˆ¹ï¼Œæˆ‘ä»¬å°±ç”¨LiveDataæ¥å®ç°ä¸€ä¸ªç®€å•å¯ç”¨çš„äº‹ä»¶æ€»çº¿æ¡†æ¶ã€‚æƒ¯ä¾‹å…ˆæ¥çœ‹çœ‹æˆæœï¼š

åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡XEventBusçš„postæ–¹æ³•å‘é€ä¸€ä¸ªäº‹ä»¶ï¼š

```
XEventBus.post(EventName.REFRESH_HOME_LIST, "é¢†ç°é‡‘é¡µé¢é€šçŸ¥é¦–é¡µåˆ·æ–°æ•°æ®")
```

è®¢é˜…æ–¹æ¥æ”¶ï¼š

```
XEventBus.observe(viewLifecycleOwner, EventName.REFRESH_HOME_LIST) { message: String ->
    Toast.makeText(context, message, Toast.LENGTH_SHORT).show()
}
```

æ€»ä½“ç±»é¢„è§ˆå¦‚ä¸‹ï¼š

[![äº‹ä»¶æ€»çº¿æ¶æ„](https://camo.githubusercontent.com/acd1876f3cec67324eaf2bd7a1a2f6a004a9a13a4aa0a2d84956f49d0859fcd4/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d613230316465383630396333623731632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/acd1876f3cec67324eaf2bd7a1a2f6a004a9a13a4aa0a2d84956f49d0859fcd4/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d613230316465383630396333623731632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

ä¸€å…±å‡ ä¸ªç±»æå®šï¼Œä¸‹é¢å¼€å§‹è®²è§£å®ç°åŸç†ã€‚

ç†Ÿæ‚‰LiveDataçš„æœ‹å‹éƒ½çŸ¥é“ï¼ŒLiveDataåœ¨æ·»åŠ æ–°çš„Observerçš„æ—¶å€™æ˜¯ä¼šæ”¶åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå®è´¨ä¸Šæ˜¯ä¸€ç§ç²˜æ€§è®¢é˜…ï¼Œå¦‚æœä¸éœ€è¦ç²˜æ€§è®¢é˜…ï¼Œé‚£ä¹ˆå°±éœ€è¦å¯¹Observerè¿›è¡Œæ”¹é€ äº†ï¼š

```
class EventObserverWrapper<T>(
    liveData: EventLiveData<T>,
    sticky: Boolean,
    private val observerDelegate: Observer<in T>
) : Observer<T> {

    private var preventNextEvent = false

    companion object {
        private const val START_VERSION = -1
    }

    init {
        if (!sticky) {
            val version = ReflectHelper.of(liveData).getField("mVersion") as? Int ?: START_VERSION
            preventNextEvent = version > START_VERSION
        }
    }

    override fun onChanged(t: T) {
        if (preventNextEvent) {
            preventNextEvent = false
            return
        }
        observerDelegate.onChanged(t)
    }
}
```

æˆ‘ä»¬é€šè¿‡ä»£ç†Observerï¼Œåœ¨æ„é€ çš„æ—¶å€™ä¼ å…¥LiveDataå’Œstickyç²˜æ€§è®¢é˜…å‚æ•°ï¼Œåœ¨initä¸­åˆ¤æ–­å¦‚æœè°ƒç”¨æ–¹ä¸éœ€è¦ç²˜æ€§è®¢é˜…ï¼Œé‚£ä¹ˆæ ¹æ®LiveDataçš„ç‰ˆæœ¬å·mVersionæ¥è·³è¿‡ä¸‹ä¸€æ¬¡onChangedçš„è§¦å‘ã€‚

å…¶ä¸­LiveDataçš„mVersionéœ€è¦é€šè¿‡åå°„æ¥è·å–ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°è£…ä¸€ä¸ªEventLiveDataï¼Œæ·»åŠ åœ¨è®¢é˜…çš„æ—¶å€™ï¼Œå¢åŠ äº†ä¸€ä¸ªstickyå‚æ•°ï¼ŒæŠŠä¼ è¿›æ¥çš„Observerç”¨EventObserverWrapperåŒ…è£…ä¸€ä¸‹ï¼š

```
class EventLiveData<T> : MutableLiveData<T>() {

    fun observe(owner: LifecycleOwner, sticky: Boolean, observer: Observer<in T>) {
        observe(owner, wrapObserver(sticky, observer))
    }

    private fun wrapObserver(sticky: Boolean, observer: Observer<in T>): Observer<T> {
        return EventObserverWrapper(this, sticky, observer)
    }
}
```

æœ€åå†å¯¹å¤–æä¾›ä¸€ä¸ªé—¨é¢ç±»ï¼š

```
object XEventBus {

    private val channels = HashMap<String, EventLiveData<*>>()

    private fun <T> with(@EventName eventName: String): EventLiveData<T> {
        synchronized(channels) {
            if (!channels.containsKey(eventName)) {
                channels[eventName] = EventLiveData<T>()
            }
            return (channels[eventName] as EventLiveData<T>)
        }
    }

    fun <T> post(@EventName eventName: String, message: T) {
        val eventLiveData = with<T>(eventName)
        eventLiveData.postValue(message!!)
    }

    fun <T> observe(owner: LifecycleOwner, @EventName eventName: String, sticky: Boolean = false, observer: Observer<T>) {
        with<T>(eventName).observe(owner, sticky, observer)
    }
}
```

åœ¨è¿™ä¸ªXEventBuså¯¹è±¡é‡Œé¢ï¼Œchannelså­˜å‚¨äº†æ‰€æœ‰EventLiveDataï¼Œé€šè¿‡withå‡½æ•°å°±å¯ä»¥æ ¹æ®eventNameè·å–ä¸€ä¸ªEventLiveDataï¼Œè¿™é‡Œéœ€è¦æ³¨æ„å¤šçº¿ç¨‹è®¿é—®HashMapçš„é—®é¢˜ã€‚

æˆ‘ä»¬è¿˜å¯¹å¤–æä¾›äº†postã€observeä¸¤ä¸ªå‡½æ•°ï¼š

- postç”¨äºå‘é€äº‹ä»¶ï¼Œéœ€è¦ä¼ å…¥äº‹ä»¶åå’Œå…·ä½“çš„æ¶ˆæ¯ï¼Œæœ€ç»ˆè°ƒç”¨LiveDataçš„postValueæ–¹æ³•
- observeç”¨äºè®¢é˜…äº‹ä»¶ï¼Œéœ€è¦ä¼ å…¥äº‹ä»¶åå’ŒObserverï¼Œæœ€ç»ˆè°ƒç”¨LiveDataçš„observeæ–¹æ³•

é€šè¿‡LiveDataå°è£…äº‹ä»¶æ€»çº¿ï¼Œæˆ‘ä»¬çœå»äº†æ‰‹åŠ¨å–æ¶ˆè®¢é˜…çš„æ“ä½œï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒéº»çƒ¦çš„äº‹ä»¶è¿˜æ²¡è§£å†³ï¼Œå°±æ˜¯é€šè¿‡observeè€Œä¸æ˜¯observeForeveræ¥è®¢é˜…ï¼Œåªèƒ½åœ¨LifecycleOwneræ´»è·ƒçš„æƒ…å†µä¸‹æ‰èƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œä¾‹å¦‚ç»™ä¸€ä¸ªå·²ç»pauseçš„Activityå‘é€ä¸€ä¸ªäº‹ä»¶ï¼Œåªèƒ½åœ¨è¿”å›è¿™ä¸ªActivityçš„æ—¶å€™æ‰èƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚

ç±»ä¼¼è¿™ç§â€œç»™ä¸€ä¸ªå·²ç»pauseçš„Activity/Fragmentå‘é€ä¸€ä¸ªäº‹ä»¶â€è¿™ç§æƒ…å†µï¼Œå…¶å®åœ¨å®é™…åº”ç”¨ä¸­æ˜¯éå¸¸å¸¸è§çš„ï¼Œå…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡observeForeveræ¥è®¢é˜…ï¼Œä½†æ˜¯è¿™ç§è®¢é˜…éœ€è¦æ‰‹åŠ¨å–æ¶ˆè®¢é˜…ï¼Œä¼šå¸¦æ¥APIä½¿ç”¨çš„ä¸ä¾¿åˆ©ã€‚ä¸ºäº†èƒ½å¤Ÿåˆ©ç”¨observeè¿™ç§è‡ªåŠ¨å–æ¶ˆè®¢é˜…çš„ä¾¿åˆ©æ€§ï¼Œåˆèƒ½å¤Ÿåœ¨pauseçŠ¶æ€ä¸‹æ”¶åˆ°äº‹ä»¶ï¼Œç¬”è€…å†³å®šè‡ªå·±ç§»æ¤LiveDataçš„æºç æ¥è¾¾åˆ°è¿™ä¸ªæ•ˆæœã€‚

æŠŠLiveDataåŒ…é‡Œé¢çš„å‡ ä¸ªç±»æ‹·è´åˆ°è‡ªå·±çš„é¡¹ç›®ä¸‹é¢ï¼Œä¿®æ”¹è§¦å‘äº‹ä»¶å›è°ƒçš„considerNotifyæ–¹æ³•ï¼Œå»æ‰åˆ¤æ–­Observeræ˜¯å¦æ´»è·ƒçš„é€»è¾‘å°±å¯ä»¥äº†ï¼š

```
private void considerNotify(ObserverWrapper observer) {
    /* ä¿®æ”¹æºç ï¼Œå®ç°åå°æ”¶æ¶ˆæ¯åŠŸèƒ½
    if (!observer.mActive) {
        return;
    }
    // Check latest state b4 dispatch. Maybe it changed state but we didn't get the event yet.
    //
    // we still first check observer.active to keep it as the entrance for events. So even if
    // the observer moved to an active state, if we've not received that event, we better not
    // notify for a more predictable notification order.
    if (!observer.shouldBeActive()) {
        observer.activeStateChanged(false);
        return;
    }
    */

    if (observer.mLastVersion >= mVersion) {
        return;
    }
    observer.mLastVersion = mVersion;
    observer.mObserver.onChanged((T) mData);
}
```

å¯¹äºæ²¡æœ‰LifecycleOwnerçš„åœºæ™¯ï¼Œéœ€è¦è‡ªå·±å®ç°LifecycleOwnerå³å¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹é€šè¿‡Activity/Fragmentéƒ½æ˜¯å¯ä»¥ç›´æ¥è·å–LifecycleOwnerçš„ã€‚

è‡³æ­¤ï¼Œäº‹ä»¶æ€»çº¿æ¶æ„çš„å°è£…å°±å®Œæˆäº†ã€‚

### åˆ—è¡¨æ¶æ„å°è£…

è¿™ä¸€å—æ˜¯æ•´ä¸ªé¡¹ç›®çš„é‡ä¸­ä¹‹é‡ï¼Œä¹Ÿæ˜¯é¡¹ç›®é‡Œé¢æœ€ä¸ºå¸¸ç”¨å’Œå¤æ‚çš„åŠŸèƒ½ï¼Œå¦‚æœå°è£…å¾—ä¸å¥½ï¼Œä¼šå¾ˆå½±å“å¼€å‘æ•ˆç‡å’Œé¡¹ç›®è´¨é‡ï¼Œè¿™ä¸€å—çš„ç—›ç‚¹éœ€æ±‚æœ‰ï¼š

- Adapterå’ŒItemçš„é«˜å¯å¤ç”¨
- ä¸ViewModelæ‰“é€šï¼Œé€šè¿‡ViewModelåŠ è½½æ•°æ®
- å¯é…ç½®æ€§è¶³å¤Ÿå¼ºå¤§ï¼Œä½†æ˜¯åˆæ— éœ€é‡å¤é…ç½®ä¸€äº›ç´¯èµ˜çš„å±æ€§ï¼Œæ¯”å¦‚Adapterã€LayoutManagerç­‰
- æ”¯æŒä¸‹æ‹‰åˆ·æ–°ã€ä¸Šæ‹‰åŠ è½½çš„å¼€å¯å’Œå…³é—­
- æ”¯æŒæ•°æ®é¢„åŠ è½½
- ç©ºç™½é¡µã€å¼‚å¸¸é¡µé¢
- æ”¯æŒæœ¬åœ°æ•°æ®åŠ è½½ã€ç½‘ç»œæ•°æ®åŠ è½½ã€‚åœ¨åŠ è½½ç½‘ç»œæ•°æ®å¼‚å¸¸çš„æƒ…å†µä¸‹æ ¹æ®ç½‘ç»œçŠ¶æ€è‡ªåŠ¨é‡è¯•
- æ”¯æŒå¸¸è§çš„ç›‘å¬ï¼Œæ¯”å¦‚çŸ­æŒ‰ã€é•¿æŒ‰ã€Itemå­Viewçš„ç‚¹å‡»ç›‘å¬
- ç­‰ç­‰

åŸºäºä»¥ä¸Šæ€è€ƒï¼Œç¬”è€…ä¸ºé¡¹ç›®å°è£…äº†ä¸€ä¸ªXRecyclerViewæ§ä»¶ï¼Œä½¿ç”¨çš„æ–¹æ³•å¾ˆç®€å•ï¼š

1. åœ¨xmlé‡Œé¢æ”¾ç½®ä¸€ä¸ªXRecyclerView
2. åœ¨ä»£ç é‡Œé¢è¿›è¡Œç®€å•çš„é…ç½®
3. ç»§æ‰¿BaseRecyclerViewModelå¹¶ä¸”å®ç°é‡Œé¢çš„æœ€æ ¸å¿ƒçš„loadDataæ–¹æ³•

XRecyclerViewçš„é…ç½®ç¤ºä¾‹ä»£ç åœ¨HomeFragment.ktï¼Œå¦‚ä¸‹ï¼š

```
viewBinding.rvList.init(
    XRecyclerView.Config()
        .setViewModel(viewModel)
        .setOnItemClickListener(object : XRecyclerView.OnItemClickListener {
            override fun onItemClick(parent: RecyclerView, view: View, viewData: BaseViewData<*>, position: Int, id: Long) {
                Toast.makeText(context, "æ¡ç›®ç‚¹å‡»: ${viewData.value}", Toast.LENGTH_SHORT).show()
            }
        })
        .setOnItemChildViewClickListener(object : XRecyclerView.OnItemChildViewClickListener {
            override fun onItemChildViewClick(parent: RecyclerView, view: View, viewData: BaseViewData<*>, position: Int, id: Long, extra: Any?) {
                if (extra is String) {
                    Toast.makeText(context, "æ¡ç›®å­Viewç‚¹å‡»: $extra", Toast.LENGTH_SHORT).show()
                }
            }
        })
)
```

é€šè¿‡è°ƒç”¨XRecyclerViewçš„initæ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªåŒ…å«ç€æ‰€æœ‰é…ç½®ä¿¡æ¯çš„XRecyclerView.Configå¯¹è±¡å³å¯ã€‚å…¶ä¸­å¤§éƒ¨åˆ†é…ç½®å¦‚æœæ— éœ€é…ç½®çš„è¯å¯ä»¥ä¸è¿›è¡Œé…ç½®ç›´æ¥ä½¿ç”¨æ¨èçš„é»˜è®¤å€¼ã€‚

åœ¨ç¤ºä¾‹ä»£ç å½“ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†Itemçš„ç‚¹å‡»ç›‘å¬å’ŒItemä¸Šé¢å­Viewçš„ç‚¹å‡»ç›‘å¬ï¼Œå¦å¤–æˆ‘ä»¬è¿˜ä¼ å…¥äº†ä¸€ä¸ªBaseRecyclerViewModelå¯¹è±¡ï¼Œä¸»è¦è´Ÿè´£ä¸ºXRecyclerViewæä¾›æ•°æ®æ¥æºï¼Œå®ç°å¯å‚è€ƒHomeViewModel.ktï¼Œå¦‚ä¸‹ï¼š

```
class HomeViewModel : BaseRecyclerViewModel() {

    override fun loadData(isLoadMore: Boolean, isReLoad: Boolean, page: Int) {
        viewModelScope.launch {
            // æ¨¡æ‹Ÿç½‘ç»œæ•°æ®åŠ è½½
            delay(1000L)

            val time = DateFormat.format("MM-dd HH:mm:ss", System.currentTimeMillis())

            val viewDataList: List<BaseViewData<*>>
            if (!isLoadMore) {
                viewDataList = listOf<BaseViewData<*>>(
                    Test1ViewData("a-$time"),
                    ...
                )
            } else {
                // åœ¨ç¬¬5é¡µæ¨¡æ‹Ÿç½‘ç»œå¼‚å¸¸
                if (page == 5) {
                    postError(isLoadMore)
                    return@launch
                }
                viewDataList = listOf<BaseViewData<*>>(
                    Test1ViewData("a-$time"),
                    ...
                )
            }
            postData(isLoadMore, viewDataList)
        }
    }

    @PageName
    override fun getPageName() = PageName.HOME
}
```

åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š

1. ç»§æ‰¿BaseRecyclerViewModelï¼Œå®ç°æœ€é‡è¦çš„loadDataå‡½æ•°
2. åœ¨loadDataï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°å½“å‰åŠ è½½æ˜¯å¦ä¸ºé¦–é¡µæ•°æ®åŠ è½½æˆ–è€…æ˜¯æ›´å¤šæ•°æ®åŠ è½½ï¼Œæ˜¯å¦ä¸ºé‡è¯•åŠ è½½ï¼Œé¡µç ä»¥åŠæ¸¸æ ‡åç§»ç­‰
3. æ ¹æ®ä¸Šè¿°å‚æ•°ï¼Œå¼€å¯åç¨‹ï¼Œè¯·æ±‚æ•°æ®ï¼ŒæŠŠæ•°æ®å°è£…æˆBaseViewData<*>åˆ—è¡¨ï¼Œé€šè¿‡è°ƒç”¨çˆ¶ç±»æä¾›çš„postDataæäº¤æ•°æ®
4. ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨çˆ¶ç±»æä¾›çš„postErroræäº¤åŠ è½½å‡ºé”™

ä¸‹é¢å¼€å§‹ç®€è¦è¯´æ˜åˆ—è¡¨æ¶æ„çš„å®ç°åŸç†ã€‚æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![åˆ—è¡¨æ¶æ„](https://camo.githubusercontent.com/5ac5463268510648f1d5dee53b4bfb87f629b256bf5844e076d157e9c85301c0/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d376537623232633864346538666233362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/5ac5463268510648f1d5dee53b4bfb87f629b256bf5844e076d157e9c85301c0/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d376537623232633864346538666233362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

è¦è€ƒè™‘Itemå’ŒAdapterçš„å¤ç”¨ï¼Œæˆ‘ä»¬é€šè¿‡æºç çš„æ–¹å¼å¼•å…¥MultiTypeï¼Œå°è£…äº†ä¸€ä¸ªBaseAdapterï¼Œå¹¶ä¸”åœ¨é‡Œé¢æä¾›ä¸€äº›æœ€é€šç”¨çš„å‡½æ•°ï¼š

```
open class BaseAdapter : MultiTypeAdapter() {

    init {
        register(LoadMoreViewDelegate())
        ...
    }

    open fun setViewData(viewData: List<BaseViewData<*>>) {
        items.clear()
        items.addAll(viewData)
        notifyDataSetChanged()
    }

    ...
}
```

å¦å¤–ï¼Œæ ¹æ®MultiTypeçš„ç”¨æ³•ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªBaseItemViewDelegateï¼š

```
abstract class BaseItemViewDelegate<T : BaseViewData<*>, VH : RecyclerView.ViewHolder> : ItemViewDelegate<T, VH>() {

    @CallSuper
    override fun onBindViewHolder(holder: VH, item: T) {
        holder.itemView.setOnClickListener {
            performItemClick(it, item, holder)
        }
        holder.itemView.setOnLongClickListener {
            return@setOnLongClickListener performItemLongClick(it, item, holder)
        }
    }

    /**
     * æ¡ç›®ç‚¹å‡»ç›‘å¬
     */
    protected fun performItemClick(view: View, item: BaseViewData<*>, holder: RecyclerView.ViewHolder) {
        val recyclerView = getRecyclerView(view)
        if (null != recyclerView) {
            val position: Int = holder.absoluteAdapterPosition
            val id = holder.itemId
            recyclerView.performItemClick(view, item, position, id)
        }
    }

    /**
     * æ¡ç›®é•¿æŒ‰ç›‘å¬
     */
    protected fun performItemLongClick(view: View, item: BaseViewData<*>, holder: RecyclerView.ViewHolder): Boolean {
        var consumed = false
        val recyclerView = getRecyclerView(view)
        if (null != recyclerView) {
            val position: Int = holder.absoluteAdapterPosition
            val id = holder.itemId
            consumed = recyclerView.performItemLongClick(view, item, position, id)
        }
        return consumed
    }

    /**
     * å­Viewç‚¹å‡»ç›‘å¬
     */
    protected fun performItemChildViewClick(view: View, item: BaseViewData<*>, holder: RecyclerView.ViewHolder, extra: Any?) {
        val recyclerView = getRecyclerView(view)
        if (null != recyclerView) {
            val position: Int = holder.absoluteAdapterPosition
            val id = holder.itemId
            recyclerView.performItemChildViewClick(view, item, position, id, extra)
        }
    }

    /**
     * è·å–è£…è½½è‡ªå·±çš„XRecyclerView
     */
    private fun getRecyclerView(child: View): XRecyclerView? {
        var recyclerView: XRecyclerView? = null
        var parent: ViewParent = child.parent
        while (parent is ViewGroup) {
            if (parent is XRecyclerView) {
                recyclerView = parent
                break
            }
            parent = parent.getParent()
        }
        return recyclerView
    }

}
```

åœ¨BaseItemViewDelegateé‡Œé¢ï¼Œæˆ‘ä»¬å¤„ç†äº†RecyclerViewçš„æ‰€æœ‰ç‚¹å‡»ç›‘å¬ï¼ŒåŒ…æ‹¬çŸ­æŒ‰ã€é•¿æŒ‰ã€Itemå­Viewçš„ç‚¹å‡»ç›‘å¬ï¼Œé€šè¿‡ä¸æ–­å›æº¯çˆ¶Viewçš„æ–¹å¼ï¼Œæœ€ç»ˆå°†ç‚¹å‡»äº‹ä»¶å§”æ‰˜ç»™æˆ‘ä»¬å°†è¦å°è£…çš„XRecyclerViewæ¥å¤„ç†ï¼Œæœ€ç»ˆäº¤ç”±ä½¿ç”¨æ–¹ï¼ˆActivity/Fragmentç­‰ï¼‰æ¥å›è°ƒã€‚

MultiTypeçš„æ ¸å¿ƒæ€æƒ³æ˜¯ä¸€ç§classå¯¹åº”ä¸€ç§Itemï¼Œä¸ºäº†è¿›ä¸€æ­¥éš”ç¦»å¹¶ä¸”ä½¿å¾—ç›¸åŒçš„classå¯ä»¥å¯¹åº”å¤šç§Itemï¼Œæˆ‘ä»¬æŠ½è±¡äº†ä¸€ä¸ªBaseViewDataåŒ…è£…ç±»ï¼š

```
open class BaseViewData<T>(var value: T) {
    ...
}
```

é‚£ä¹ˆé€šè¿‡ç»§æ‰¿å®ç°ä¸åŒçš„BaseViewDataå°±å¯ä»¥ä¸åŒçš„Itemï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æŠŠMultiTypeçš„æºç ä½œç›¸åº”ä¿®æ”¹ã€‚

æ—¢ç„¶å®ç°ä¸åŒçš„BaseViewDataå°±å¯ä»¥ä¸åŒçš„Itemï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°å°±æƒ³åˆ°æˆ‘ä»¬çš„ä¸Šæ‹‰åŠ è½½æ€ä¹ˆå®ç°äº†ï¼Œå®ç°ä¸€ä¸ªLoadMoreViewDataå’ŒLoadMoreViewDelegateï¼Œå½“æˆæ˜¯æ™®é€šçš„Itemæ¥å¤„ç†å°±å¥½äº†ã€‚

```
class LoadMoreViewData(@LoadMoreState loadMoreState: Int) : BaseViewData<Int>(loadMoreState) {
}

class LoadMoreViewDelegate : BaseItemViewDelegate<LoadMoreViewData, LoadMoreViewDelegate.ViewHolder>() {

    ...

    class ViewHolder(val viewBinding: ViewRecyclerFooterBinding) : RecyclerView.ViewHolder(viewBinding.root) {

    }
}
```

æ¥ä¸‹æ¥ç»§ç»­å®ç°åŠ è½½æ›´å¤šçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦ç»§æ‰¿BaseAdapterå°è£…ä¸€ä¸ªLoadMoreAdapterï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å°†LoadMoreViewDataå§‹ç»ˆä½œä¸ºåˆ—è¡¨çš„æœ€åä¸€é¡¹æ¥å¤„ç†ï¼Œå¹¶ä¸”å¯¹å¤–æä¾›setLoadMoreStateå‡½æ•°æ¥è®¾ç½®åŠ è½½æ›´å¤šçš„çŠ¶æ€ã€‚

ç®€è¦ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```
class LoadMoreAdapter : BaseAdapter() {

    private val loadMoreViewData = LoadMoreViewData(LoadMoreState.LOADING)

    /**
     * é‡å†™setViewDataï¼Œæ·»åŠ åŠ è½½æ›´å¤šæ¡ç›®
     */
    override fun setViewData(viewData: List<BaseViewData<*>>) {
        val mutableViewData = viewData.toMutableList()
        mutableViewData.add(loadMoreViewData)
        super.setViewData(mutableViewData)
    }

    fun setLoadMoreState(@LoadMoreState loadMoreState: Int) {
        val position = itemCount - 1
        if (isLoadMoreViewData(position)) {
            loadMoreViewData.value = loadMoreState
            notifyItemChanged(position)
        }
    }

    ...
}
```

æ¥ä¸‹æ¥å®ç°é¢„åŠ è½½è¿™ä¸€å—ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å…ˆå°è£…ä¸€ä¸ªLoadMoreRecyclerViewï¼ŒåŸç†æ˜¯é€šè¿‡addOnScrollListeneræ¥åˆ¤æ–­RecyclerViewçš„æ»šåŠ¨çŠ¶æ€å’Œæ•°é‡ï¼Œè§¦å‘é¢„åŠ è½½çš„onLoadMoreå›è°ƒï¼š

```
class LoadMoreRecyclerView @JvmOverloads constructor(
    context: Context, attrs: AttributeSet? = null
) : RecyclerView(context, attrs) {

    private var onLoadMoreListener: OnLoadMoreListener? = null
    private lateinit var scrollChangeListener: LoadMoreRecyclerScrollListener

    override fun setAdapter(adapter: Adapter<*>?) {
        // ä¼ è¿›æ¥çš„Adapterå¿…é¡»æ˜¯BaseLoadMoreAdapter
        val loadMoreAdapter = adapter as LoadMoreAdapter
        // å¿…é¡»å…ˆè®¾ç½®LayoutManagerå†è®¾ç½®Adapter
        scrollChangeListener = object : LoadMoreRecyclerScrollListener(layoutManager!!) {
            override fun onLoadMore(page: Int, totalItemsCount: Int) {
                // è§¦å‘é¢„åŠ è½½
                if (canLoadMore) {
                    onLoadMoreListener?.onLoadMore(page, totalItemsCount)
                }
            }
        }
        addOnScrollListener(scrollChangeListener)
        super.setAdapter(adapter)
    }

    fun setOnLoadMoreListener(listener: OnLoadMoreListener) {
        this.onLoadMoreListener = listener
    }

    interface OnLoadMoreListener {
        fun onLoadMore(page: Int, totalItemsCount: Int)
    }

    ...
}
```

åŠ è½½æ›´å¤šå®Œæˆåï¼Œæˆ‘ä»¬å¼€å§‹è€ƒè™‘ä¸‹æ‹‰åˆ·æ–°æ€ä¹ˆå®ç°äº†ã€‚è¿™ä¸€å—å°±ä¸è¯¦ç»†è¯´æ˜äº†ï¼Œä¸»è¦æ˜¯åˆ©ç”¨PtrFrameLayoutæ¥è¿›è¡Œå°è£…ä¸€ä¸ªPullRefreshLayoutï¼š

```
class PullRefreshLayout @JvmOverloads constructor(
    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0
) : PtrFrameLayout(context, attrs, defStyleAttr), PtrUIHandler {

    ...

}
```

æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ•°æ®çš„æ¥æºï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€šç”¨çš„BaseRecyclerViewModelåŸºç±»ï¼š

```
abstract class BaseRecyclerViewModel : BaseViewModel() {

    /**
     * é¦–é¡µ/ä¸‹æ‹‰åˆ·æ–°çš„æ•°æ®
     */
    val firstViewDataLiveData = MutableLiveData<List<BaseViewData<*>>>()

    /**
     * æ›´å¤šçš„æ•°æ®
     */
    val moreViewDataLiveData = MutableLiveData<List<BaseViewData<*>>>()

    /**
     * é¡µç 
     */
    private var currentPage = AtomicInteger(0)


    /**
     * å­ç±»é‡å†™è¿™ä¸ªå‡½æ•°åŠ è½½æ•°æ®
     * æ•°æ®åŠ è½½å®Œæˆåé€šè¿‡postDataæäº¤æ•°æ®
     * æ•°æ®åŠ è½½å®Œæˆåé€šè¿‡postErroræäº¤å¼‚å¸¸
     *
     * @param isLoadMore å½“æ¬¡æ˜¯å¦ä¸ºåŠ è½½æ›´å¤š
     * @param isReLoad   å½“æ¬¡æ˜¯å¦ä¸ºé‡æ–°åŠ è½½(æ­¤æ—¶pageç­‰å‚æ•°ä¸åº”è¯¥æ”¹å˜)
     * @param page       é¡µç 
     */
    abstract fun loadData(isLoadMore: Boolean, isReLoad: Boolean, page: Int)

    fun loadDataInternal(isLoadMore: Boolean, isReLoad: Boolean) {
        if (needNetwork() && !isNetworkConnect()) {
            postError(isLoadMore)
            return
        }
        if (!isLoadMore) {
            currentPage.set(0)
        } else if (!isReLoad) {
            currentPage.incrementAndGet()
        }
        loadData(isLoadMore, isReLoad, currentPage.get())
    }

    /**
     * æäº¤æ•°æ®
     */
    protected fun postData(isLoadMore: Boolean, viewData: List<BaseViewData<*>>) {
        if (isLoadMore) {
            moreViewDataLiveData.postValue(viewData)
        } else {
            firstViewDataLiveData.postValue(viewData)
        }
    }

    /**
     * æäº¤åŠ è½½å¼‚å¸¸
     */
    protected fun postError(isLoadMore: Boolean) {
        if (isLoadMore) {
            moreViewDataLiveData.postValue(LoadError)
        } else {
            firstViewDataLiveData.postValue(LoadError)
        }
    }

    ...
}
```

BaseRecyclerViewModelçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æä¾›loadDataInternalå‡½æ•°ç»™å°†è¦å°è£…çš„XRecyclerViewæ¥è°ƒç”¨ï¼Œè§¦å‘æ•°æ®åŠ è½½é€»è¾‘ï¼Œç„¶åBaseRecyclerViewModelçš„å­ç±»å¯ä»¥é‡å†™loadDataå‡½æ•°æ¥å®ç°å…·ä½“çš„æ•°æ®åŠ è½½é€»è¾‘ã€‚ç”±äºå­ç±»ä¸€èˆ¬ä¼šåœ¨loadDataé‡Œé¢å¼€å¯çº¿ç¨‹æ¥åŠ è½½æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œçš„é¡µç ç­‰ä¿¡æ¯æˆ‘ä»¬éœ€è¦ä½¿ç”¨åŸå­ç±»æ¥åŒ…è£…å¤„ç†ã€‚

æ•°æ®åŠ è½½å®Œæˆåï¼Œé€šè¿‡postDataæˆ–è€…postErrorå‘LiveDataå‘é€æ•°æ®ï¼Œåœ¨XRecyclerViewåšä¸ªç›‘å¬å°±å¯ä»¥æ‹¿åˆ°è¿™äº›æ•°æ®ï¼Œæœ€ç»ˆäº¤ç»™Adapteræ¥å¤„ç†åˆ·æ–°RecyclerViewã€‚

æœ€åï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªé—¨é¢æ§ä»¶XRecyclerViewï¼Œå°†æ‰€æœ‰åŠŸèƒ½åŒ…è£…èµ·æ¥ï¼š

```
class XRecyclerView @JvmOverloads constructor(
    context: Context, attrs: AttributeSet? = null
) : ConstraintLayout(context, attrs) {

    fun init(config: Config) {
        config.check(context)
        this.config = config
        initView()
        initData()
    }

    private fun initView() {
    }

    private fun initData() {
    }

    class Config {

    }

    ...
}
```

XRecyclerViewæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç»„åˆæ§ä»¶ï¼Œé€šè¿‡Configæ¥å¯¹å¤–æä¾›é…ç½®å…¥å£ï¼Œå°è£…äº†è¯¸å¦‚ç©ºç™½å¼‚å¸¸é¡µã€Loadingç­‰æ§ä»¶ã€‚å¦å¤–æˆ‘ä»¬è¿˜ç›‘å¬äº†ç½‘ç»œçŠ¶æ€å®ç°äº†è‡ªåŠ¨é‡è¯•ï¼Œè¿™äº›å°±ä¸ä»”ç»†å±•å¼€äº†ã€‚

### ç½‘ç»œæ¶æ„æ­å»º

ç½‘ç»œæ¶æ„è¿™ä¸€å—ï¼Œé‡‡ç”¨Retrofit+OkHttp+åç¨‹æ¥è¿›è¡Œå°è£…ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹æ€»ä½“é¢„è§ˆï¼š

[![ç½‘ç»œæ¶æ„](https://camo.githubusercontent.com/cb60c8309399d28b0786eafeca3751b87f247d5e86113661c84f280223bb7bdd/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d653231313130353132333735333039662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/cb60c8309399d28b0786eafeca3751b87f247d5e86113661c84f280223bb7bdd/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d653231313130353132333735333039662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

æˆ‘ä»¬è¿˜æ˜¯å…ˆçœ‹ä¸€ä¸‹å°è£…æˆæœã€‚

åœ¨ç½‘ç»œè¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåœ¨å®šä¹‰ç½‘ç»œæ¥å£ï¼š

```
interface INetworkService {

    @GET("videodetail")
    suspend fun requestVideoDetail(@Query("id") id: String): BaseResponse<VideoBean>
}
```

ç„¶åä¸€ä¸ªç½‘ç»œinterfaceå¯¹åº”åˆ›å»ºä¸€ä¸ªç®€å•çš„BaseNetworkApiç±»å‹çš„å¯¹è±¡ï¼Œæ¯”å¦‚NetworkApiï¼š

```
object NetworkApi : BaseNetworkApi<INetworkService>("http://172.16.47.112:8080/XArchServer/") {

    suspend fun requestVideoDetail(id: String) = getResult {
        service.requestVideoDetail(id)
    }
}
```

åœ¨ç»§æ‰¿å¹¶åˆ›å»ºBaseNetworkApiå¯¹è±¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥baseUrlç»™BaseNetworkApiçš„æ„é€ è¡Œæ•°ï¼Œæ³›å‹å‚æ•°ä¼ å…¥æˆ‘ä»¬åˆšåˆšå®šä¹‰å¥½çš„ç½‘ç»œinterfaceã€‚æœ€åå¯¹å¤–æä¾›ç½‘ç»œAPIçš„æŒ‚èµ·å‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨service.xxx()å‡½æ•°è¿›è¡Œå…·ä½“çš„ç½‘ç»œè¯·æ±‚ï¼Œè€Œserviceå°±æ˜¯ç½‘ç»œinterfaceçš„å…·ä½“å®ç°ã€‚

å¦å¤–æˆ‘ä»¬è¿˜ç”¨getResultåŒ…è£…äº†ä¸€ä¸‹ï¼Œç›®çš„æ˜¯åšç½‘ç»œé”™è¯¯å¤„ç†å’Œè¯·æ±‚é‡è¯•ï¼Œä»¥åŠå°†BaseResponseè½¬æ¢æˆå¸¦å¼‚å¸¸ä¿¡æ¯çš„Resultï¼Œå…¶ä¸­Resultè¿™ä¸ªç±»æ˜¯Kotlinç»™æˆ‘ä»¬æä¾›çš„ä¸€ä¸ªæ ‡å‡†çš„ç±»ã€‚

æœ€åï¼Œæˆ‘ä»¬åœ¨ViewModelé‡Œé¢å¼€å¯ä¸€ä¸ªåç¨‹ï¼Œä»…ä»…é€šè¿‡è°ƒç”¨NetworkApiçš„requestXXXæ–¹æ³•å°±å¯ä»¥æ‹¿åˆ°ç½‘ç»œè¯·æ±‚ç»“æœäº†ï¼š

```
class SmallVideoViewModel : BaseViewModel() {

    val helloWorldLiveData = MutableLiveData<Result<VideoBean>>()

    fun requestVideoDetail(id: String) {
        viewModelScope.launch {
            val result = NetworkApi.requestVideoDetail(id)
            helloWorldLiveData.value = result
        }
    }
}
```

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ç½‘ç»œè¯·æ±‚ç¤ºä¾‹äº†ï¼Œè®°å¾—è¦å…ˆå¯åŠ¨æœåŠ¡ç«¯çš„Tomcatæ‰èƒ½æµ‹è¯•æˆåŠŸï¼Œå¯¹åº”çš„æœåŠ¡ç«¯æºç åœ¨è¿™é‡Œï¼ˆç”¨IDEAæ‰“å¼€å³å¯ï¼‰ï¼šhttps://github.com/huannan/XArchServer

æœåŠ¡ç«¯å°±æ˜¯æœ€ç®€å•çš„Java Webé¡¹ç›®ï¼Œå°è£…äº†æœ€åŸºç¡€çš„Servletï¼Œä»¥åŠå¼•å…¥äº†FastJsonï¼Œä»£ç éƒ½æ¯”è¾ƒç®€å•å°±ä¸è¯¦ç»†è§£é‡Šäº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ã€‚é¡¹ç›®æ¶æ„å¦‚ä¸‹ï¼š

[![æœåŠ¡ç«¯é¡¹ç›®æ¶æ„](https://camo.githubusercontent.com/e10829e21f8617f6b6391acc406950218a649b20d49a36c2cf2281ea792ebe77/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d366365616630353736323762396235372e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/e10829e21f8617f6b6391acc406950218a649b20d49a36c2cf2281ea792ebe77/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323537303033302d366365616630353736323762396235372e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

ä¸‹é¢å¼€å§‹è®²è§£ç½‘ç»œæ¡†æ¶é‡Œé¢æœ€é‡è¦çš„åŸºç±»BaseNetworkApiï¼š

```
abstract class BaseNetworkApi<I>(private val baseUrl: String) : IService<I> {

    protected val service: I by lazy {
        getRetrofit().create(getServiceClass())
    }

    protected open fun getRetrofit(): Retrofit {
        return Retrofit.Builder()
            .baseUrl(baseUrl)
            .client(getOkHttpClient())
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    private fun getServiceClass(): Class<I> {
        val genType = javaClass.genericSuperclass as ParameterizedType
        return genType.actualTypeArguments[0] as Class<I>
    }

    private fun getOkHttpClient(): OkHttpClient {
        val okHttpClient = getCustomOkHttpClient()
        if (null != okHttpClient) {
            return okHttpClient
        }
        return defaultOkHttpClient
    }

    protected open fun getCustomOkHttpClient(): OkHttpClient? {
        return null
    }

    protected open fun getCustomInterceptor(): Interceptor? {
        return null
    }

    protected suspend fun <T> getResult(block: suspend () -> BaseResponse<T>): Result<T> {
        for (i in 1..RETRY_COUNT) {
            try {
                val response = block()
                if (response.code != ErrorCode.OK) {
                    throw NetworkException.of(response.code, "response code not 200")
                }
                if (response.value == null) {
                    throw NetworkException.of(ErrorCode.VALUE_IS_NULL, "response value is null")
                }
                return Result.success(response.value)
            } catch (throwable: Throwable) {
                if (throwable is NetworkException) {
                    return Result.failure(throwable)
                }
                if ((throwable is HttpException && throwable.code() == ErrorCode.UNAUTHORIZED)) {
                    // è¿™é‡Œåˆ·æ–°tokenï¼Œç„¶åé‡è¯•
                }
            }
        }
        return Result.failure(NetworkException.of(ErrorCode.VALUE_IS_NULL, "unknown"))
    }

    companion object {
        private const val RETRY_COUNT = 2
        private val defaultOkHttpClient by lazy {
            val builder = OkHttpClient.Builder()
                .callTimeout(10L, TimeUnit.SECONDS)
                .connectTimeout(10L, TimeUnit.SECONDS)
                .readTimeout(10L, TimeUnit.SECONDS)
                .writeTimeout(10L, TimeUnit.SECONDS)
                .retryOnConnectionFailure(true)

            builder.addInterceptor(CommonRequestInterceptor())
            builder.addInterceptor(CommonResponseInterceptor())
            if (BuildConfig.DEBUG) {
                val loggingInterceptor = HttpLoggingInterceptor()
                loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY)
                builder.addInterceptor(loggingInterceptor)
            }

            builder.build()
        }
    }
}
```

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨äº†æ³›å‹æ“¦é™¤çš„ç‰¹æ€§ï¼Œåœ¨åˆ›å»ºä¸€ä¸ªå¸¦æ³›å‹å‚æ•°çš„Interfaceä¹Ÿå°±æ˜¯IServiceï¼Œé‚£ä¹ˆåœ¨BaseNetworkApié‡Œé¢å°±å¯ä»¥é€šè¿‡getServiceClasså‡½æ•°æ¥è·å–å­ç±»ä¼ è¿›æ¥çš„æ³›å‹å‚æ•°ã€‚

ç„¶åå°±æ˜¯å¯¹å¤–æä¾›äº†serviceçš„å®ç°ï¼Œserviceæ˜¯é€šè¿‡lazyæ¥å»¶è¿ŸåŠ è½½ï¼Œå…·ä½“å°±æ˜¯Retrofit+OkHttpé‚£ä¸€å¥—ä¸œè¥¿ï¼Œç›¸ä¿¡å¤§å®¶éƒ½çƒ‚ç†Ÿäºå¿ƒäº†ã€‚å…¶ä¸­defaultOkHttpClientç¬”è€…æ”¾åˆ°äº†ä¼´ç”Ÿå¯¹è±¡é‡Œé¢ï¼Œç›®çš„æ˜¯ä¿è¯defaultOkHttpClientæœ‰ä¸”åªæœ‰ä¸€ä¸ªã€‚

æœ€åä¹Ÿå°±æ˜¯æœ€å¤æ‚çš„ç½‘ç»œé‡è¯•å’Œå¼‚å¸¸å¤„ç†è¿™ä¸€å—ï¼Œå¯¹å­ç±»æä¾›äº†ä¸€ä¸ªgetResultå‡½æ•°ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯å°†ç½‘ç»œè¯·æ±‚ä¿è¯æˆä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œåœ¨å¾ªç¯ä¸­è°ƒç”¨ï¼Œå¾ªç¯çš„æ¬¡æ•°å°±æ˜¯ç½‘ç»œé‡è¯•çš„æ¬¡æ•°ã€‚åœ¨å¾ªç¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç½‘ç»œè¿”å›çš„ä¿¡æ¯è¿›è¡Œå¼‚å¸¸å¤„ç†å’Œé‡è¯•ï¼ˆå³æ§åˆ¶æ˜¯å¦returnï¼‰ã€‚

å¦å¤–ï¼Œåœ¨getResultå‡½æ•°é‡Œé¢ï¼Œæˆ‘ä»¬è¿˜å°†BaseResponseçš„æ¢æˆäº†Resultï¼Œç›®çš„æ˜¯å°†å¼‚å¸¸ä¿¡æ¯ä¹Ÿå¸¦å›ç»™è°ƒç”¨æ–¹ã€‚

### æŒä¹…åŒ–

è¿™ä¸€å—ä¸»è¦æ˜¯Roomçš„ä½¿ç”¨å’ŒMMKVçš„ç®€å•å°è£…ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```
@Database(entities = [User::class], version = 1)
abstract class XDatabase : RoomDatabase() {

    abstract fun userDao(): UserDao

    companion object {
        private val db: XDatabase by lazy {
            Room.databaseBuilder(
                XArchApplication.instance,
                XDatabase::class.java, "database-name"
            ).build()
        }

        fun userDao(): UserDao {
            return db.userDao()
        }
    }
}

@Dao
interface UserDao {

    @Query("SELECT * FROM user")
    suspend fun getAll(): List<User>

    ...
}
/**
 * æœ¬ç±»ä¸ºMMKVçš„å°è£…ç±»ï¼Œé˜²æ­¢ä»£ç å…¥ä¾µ
 */
object XKeyValue {

    fun init(application: Application) {
        MMKV.initialize(application)
    }

    fun putBoolean(@Key key: String, value: Boolean) {
        MMKV.defaultMMKV().encode(key, value)
    }

    fun getBoolean(@Key key: String, defaultValue: Boolean = false): Boolean {
        return MMKV.defaultMMKV().decodeBool(key, defaultValue)
    }

    fun putString(@Key key: String, value: String) {
        MMKV.defaultMMKV().encode(key, value)
    }

    fun getString(@Key key: String, defaultValue: String = ""): String {
        return MMKV.defaultMMKV().decodeString(key, defaultValue)!!
    }

    fun putInt(@Key key: String, value: Int) {
        MMKV.defaultMMKV().encode(key, value)
    }

    fun getInt(@Key key: String, defaultValue: Int = 0): Int {
        return MMKV.defaultMMKV().decodeInt(key, defaultValue)
    }

    ...
}
```

éœ€è¦æä¸€ä¸‹çš„æ˜¯Roomçš„APIå·²ç»æ”¯æŒè¿”å›æŒ‚èµ·å‡½æ•°äº†ã€‚

è¿™ä¸€å—æ¯”è¾ƒç®€å•å°±ä¸èµ˜è¿°äº†ã€‚

### æœŸæœ›å’Œæ€»ç»“

æ–‡ç« ä¸»è¦å¸¦å¤§å®¶å®ç°äº†Gradleé…ç½®ç»Ÿä¸€ç®¡ç†ã€åŸºç±»å°è£…ã€è§†å›¾ç»‘å®šã€åº•éƒ¨å¯¼èˆªæ çš„å®ç°ã€äº‹ä»¶æ€»çº¿æ¡†æ¶å°è£…ã€åˆ—è¡¨æ¶æ„å°è£…ã€ç½‘ç»œæ¶æ„æ­å»ºã€æŒä¹…åŒ–ï¼Œè®²çš„éƒ½æ˜¯ç¬”è€…åœ¨æ­å»ºæ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒæ€è·¯ï¼Œé‡Œé¢å…¶å®è¿˜æœ‰å¤§é‡é€»è¾‘å’Œç»†èŠ‚ï¼Œå¯ä»¥ç›´æ¥æŸ¥é˜…æºç ï¼š

- å®¢æˆ·ç«¯æºç ï¼š https://github.com/huannan/XArch
- æœåŠ¡ç«¯æºç ï¼š https://github.com/huannan/XArchServer

ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®è¿˜æœ‰è¯¸å¦‚ä¸‹é¢ç­‰å¤§é‡å·¥ä½œéœ€è¦å®ç°ï¼š

- è·¯ç”±ç®¡ç†è¿™ä¸€å—è¿˜æ²¡å®ç°
- å¼•å…¥DiffUtil
- ç»„ä»¶åŒ–æ”¹é€ ï¼Œå°†å„ç§ä¸šåŠ¡æ— å…³çš„åŠŸèƒ½æŠ½å–åˆ°lib-baseæ¨¡å—å¹¶ä¸”è§£å†³æ¨¡å—é—´çš„é€šä¿¡å’Œè·¯ç”±
- å®Œå–„Repositoryå±‚ç­‰ç­‰

è¿™äº›åŠŸèƒ½ç¬”è€…ä¼šåœ¨åé¢æŒç»­æ›´æ–°ï¼Œå¦‚æœè§‰å¾—è¿™ä¸ªæ¶æ„è¿˜ä¸é”™æˆ–è€…æœ‰ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åŠ ç¬”è€…å¾®ä¿¡huannan88ï¼Œå¤§å®¶ä¸€èµ·æ¥è®¨è®ºã€‚